<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ù†ØªØ®Ø§Ø¨ÙŠØ©</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f5f5f5;
    margin: 0; padding: 20px;
    direction: rtl;
}
h1 { text-align:center; color:#8B0000; margin-bottom:30px; }
.cards { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom:30px; }
.card {
    background-color:white; padding:20px; border-radius:12px; 
    box-shadow:0 4px 8px rgba(0,0,0,0.1); flex:1; min-width:200px; text-align:center;
}
.card h2 { margin:10px 0; color:#8B0000; }
.card p { font-size:1.2em; color:#333; }
.charts { display:flex; flex-wrap:wrap; gap:30px; justify-content:center; margin-bottom:30px; }
canvas { background:white; border-radius:12px; padding:10px; cursor:pointer; }
button { padding:10px 15px; background-color:#006400; color:white; border:none; border-radius:8px; cursor:pointer; margin-bottom:20px; }
button:hover { background-color:#004d00; }
#filterDiv { margin-bottom: 20px; text-align:center; }
#filterDiv select { padding:8px 12px; font-size:1em; border-radius:8px; border:1px solid #ccc; }
</style>
</head>
<body>

<h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ù†ØªØ®Ø§Ø¨ÙŠØ© ğŸ‡²ğŸ‡¦</h1>

<div class="cards">
  <div class="card"><h2 id="totalVoters">0</h2><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø§Ø®Ø¨ÙŠÙ†</p></div>
  <div class="card"><h2 id="maleVoters">0</h2><p>Ø§Ù„Ø°ÙƒÙˆØ±</p></div>
  <div class="card"><h2 id="femaleVoters">0</h2><p>Ø§Ù„Ø¥Ù†Ø§Ø«</p></div>
  <div class="card"><h2 id="districtsCount">0</h2><p>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±</p></div>
</div>

<div id="filterDiv">
  <label for="districtFilter">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©: </label>
  <select id="districtFilter">
    <option value="all">ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±</option>
  </select>
</div>

<div class="charts">
  <canvas id="districtChart" width="400" height="300"></canvas>
  <canvas id="genderChart" width="400" height="300"></canvas>
</div>

<button onclick="toggleTable()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>

<table id="detailsTable" class="display" style="width:100%; display:none;">
  <thead>
    <tr>
      <th>Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©</th>
      <th>Ø§Ù„Ù…ÙƒØªØ¨</th>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
      <th>Ø§Ù„Ø¬Ù†Ø³</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let districtChart, genderChart;
let allData = [];

// ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel
async function loadExcel() {
  const url = 'LISTES ELECTORALES PACHALIK.xlsx';
  const data = await fetch(url).then(r => r.arrayBuffer());
  const workbook = XLSX.read(data, {type:'array'});
  const sheetName = workbook.SheetNames[0];
  const sheet = workbook.Sheets[sheetName];
  const json = XLSX.utils.sheet_to_json(sheet);
  return json;
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ÙˆØ­Ø©
async function initDashboard() {
  allData = await loadExcel();

  updateCards(allData);
  populateFilter(allData);
  renderCharts(allData);
  populateTable(allData);

  $('#detailsTable').DataTable({
    destroy: true,
    dom: 'Bfrtip',
    buttons: ['copy', 'csv', 'excel', 'print'],
    order: [[0,'asc']],
    language: {
      url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json"
    }
  });

  document.getElementById('districtFilter').addEventListener('change', e => {
    const val = e.target.value;
    const filtered = val==='all' ? allData : allData.filter(d => d['Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©'] === val);
    updateCards(filtered);
    renderCharts(filtered);
    const table = $('#detailsTable').DataTable();
    table.clear().rows.add(filtered.map(d=>[d['Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©'],d['Ø§Ù„Ù…ÙƒØªØ¨'],d['Ø§Ù„Ø§Ø³Ù…'],d['Ø§Ù„Ø¬Ù†Ø³']])).draw();
  });
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
function updateCards(data) {
  const total = data.length;
  const male = data.filter(d => d['Ø§Ù„Ø¬Ù†Ø³'] === 'Ø°ÙƒØ±').length;
  const female = data.filter(d => d['Ø§Ù„Ø¬Ù†Ø³'] === 'Ø£Ù†Ø«Ù‰').length;
  const districts = [...new Set(data.map(d => d['Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©']))].length;

  document.getElementById('totalVoters').textContent = total;
  document.getElementById('maleVoters').textContent = male;
  document.getElementById('femaleVoters').textContent = female;
  document.getElementById('districtsCount').textContent = districts;
}

// Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ„ØªØ±Ø©
function populateFilter(data) {
  const select = document.getElementById('districtFilter');
  const districts = [...new Set(data.map(d=>d['Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©']))].sort();
  districts.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d; opt.textContent = d;
    select.appendChild(opt);
  });
}

// Ø±Ø³Ù… Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
function renderCharts(data) {
  const districtCounts = {};
  const genderByDistrict = {};

  data.forEach(d => {
    const dist = d['Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©'];
    const gender = d['Ø§Ù„Ø¬Ù†Ø³'];
    districtCounts[dist] = (districtCounts[dist] || 0) + 1;
    if (!genderByDistrict[dist]) genderByDistrict[dist] = {male:0, female:0};
    if (gender==='Ø°ÙƒØ±') genderByDistrict[dist].male++;
    if (gender==='Ø£Ù†Ø«Ù‰') genderByDistrict[dist].female++;
  });

  const districtCtx = document.getElementById('districtChart').getContext('2d');
  const genderCtx = document.getElementById('genderChart').getContext('2d');

  if(districtChart) districtChart.destroy();
  if(genderChart) genderChart.destroy();

  districtChart = new Chart(districtCtx, {
    type:'bar',
    data:{
      labels:Object.keys(districtCounts),
      datasets:[{
        label:'Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø§Ø®Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©',
        data:Object.values(districtCounts),
        backgroundColor:'#8B0000'
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      onClick: (e, elements) => {
        if(elements.length>0){
          const index = elements[0].index;
          const district = districtChart.data.labels[index];
          filterByDistrict(district);
        }
      }
    }
  });

  genderChart = new Chart(genderCtx, {
    type:'bar',
    data:{
      labels:Object.keys(genderByDistrict),
      datasets:[
        {label:'Ø°ÙƒÙˆØ±', data:Object.values(genderByDistrict).map(d=>d.male), backgroundColor:'#006400'},
        {label:'Ø¥Ù†Ø§Ø«', data:Object.values(genderByDistrict).map(d=>d.female), backgroundColor:'#8B0000'}
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{position:'top'}},
      onClick: (e, elements) => {
        if(elements.length>0){
          const index = elements[0].index;
          const district = genderChart.data.labels[index];
          filterByDistrict(district);
        }
      }
    }
  });
}

// ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
function filterByDistrict(district) {
  document.getElementById('districtFilter').value = district;
  const filtered = allData.filter(d => d['Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©'] === district);
  updateCards(filtered);
  renderCharts(filtered);
  const table = $('#detailsTable').DataTable();
  table.clear().rows.add(filtered.map(d=>[d['Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©'],d['Ø§Ù„Ù…ÙƒØªØ¨'],d['Ø§Ù„Ø§Ø³Ù…'],d['Ø§Ù„Ø¬Ù†Ø³']])).draw();
}

// Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function populateTable(data) {
  const tbody = document.querySelector('#detailsTable tbody');
  tbody.innerHTML = '';
  data.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${d['Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©']}</td><td>${d['Ø§Ù„Ù…ÙƒØªØ¨']}</td><td>${d['Ø§Ù„Ø§Ø³Ù…']}</td><td>${d['Ø§Ù„Ø¬Ù†Ø³']}</td>`;
    tbody.appendChild(tr);
  });
}

// Ø¹Ø±Ø¶ / Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function toggleTable() {
  const table = document.getElementById('detailsTable');
  table.style.display = table.style.display==='none'?'table':'none';
}

initDashboard();
</script>

</body>
</html>
