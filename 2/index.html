<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Atlas.js Lite v0.1</title>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#111; }
    #map { width:100%; height:100%; touch-action:none; cursor:grab; }
    #map:active { cursor:grabbing; }
    .marker {
      position:absolute;
      width:14px; height:14px;
      background:#ff4757;
      border:2px solid #fff;
      border-radius:50%;
      transform:translate(-50%, -50%);
      box-shadow:0 0 4px rgba(0,0,0,0.5);
    }
    .attribution {
      position:absolute; bottom:4px; right:6px;
      font-size:11px; color:#aaa; background:rgba(0,0,0,0.5);
      padding:2px 4px; border-radius:3px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
  class AtlasLite {
    constructor(containerId, options = {}) {
      this.container = document.getElementById(containerId);
      this.tileSize = 256;
      this.zoom = options.zoom || 3;
      this.center = options.center || { lat: 0, lng: 0 };
      this.tiles = {};
      this.tileLayer = options.tileLayer || 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';
      this.markers = [];
      this.dragging = false;
      this.init();
    }

    init() {
      this.canvas = document.createElement('div');
      this.canvas.style.position = 'relative';
      this.canvas.style.width = '100%';
      this.canvas.style.height = '100%';
      this.container.appendChild(this.canvas);
      this.container.addEventListener('mousedown', e => this.startDrag(e));
      window.addEventListener('mouseup', () => this.stopDrag());
      window.addEventListener('mousemove', e => this.drag(e));
      this.container.addEventListener('wheel', e => this.zoomMap(e));
      this.container.addEventListener('dblclick', e => this.zoomIn(e));
      this.container.addEventListener('touchstart', e => this.touchStart(e));
      this.container.addEventListener('touchmove', e => this.touchMove(e));
      this.container.addEventListener('touchend', e => this.touchEnd(e));
      this.render();
    }

    latLngToTile(lat, lng, zoom) {
      const n = Math.pow(2, zoom);
      const x = n * ((lng + 180) / 360);
      const latRad = lat * Math.PI / 180;
      const y = n * (1 - (Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) / Math.PI)) / 2;
      return { x, y };
    }

    render() {
      const centerTile = this.latLngToTile(this.center.lat, this.center.lng, this.zoom);
      const containerRect = this.container.getBoundingClientRect();
      const cols = Math.ceil(containerRect.width / this.tileSize) + 2;
      const rows = Math.ceil(containerRect.height / this.tileSize) + 2;
      const startX = Math.floor(centerTile.x - cols / 2);
      const startY = Math.floor(centerTile.y - rows / 2);
      this.canvas.innerHTML = '';
      for (let x = startX; x < startX + cols; x++) {
        for (let y = startY; y < startY + rows; y++) {
          const img = document.createElement('img');
          img.src = this.tileLayer.replace('{z}', this.zoom).replace('{x}', x).replace('{y}', y);
          img.style.position = 'absolute';
          img.style.left = `${(x - startX) * this.tileSize}px`;
          img.style.top = `${(y - startY) * this.tileSize}px`;
          img.width = this.tileSize;
          img.height = this.tileSize;
          this.canvas.appendChild(img);
        }
      }
      this.markers.forEach(m => this.drawMarker(m.lat, m.lng));
      this.showAttribution();
    }

    drawMarker(lat, lng) {
      const marker = document.createElement('div');
      marker.className = 'marker';
      const pos = this.latLngToTile(lat, lng, this.zoom);
      const center = this.latLngToTile(this.center.lat, this.center.lng, this.zoom);
      marker.style.left = `${(pos.x - center.x) * this.tileSize + this.container.clientWidth / 2}px`;
      marker.style.top = `${(pos.y - center.y) * this.tileSize + this.container.clientHeight / 2}px`;
      this.canvas.appendChild(marker);
    }

    addMarker(lat, lng) {
      this.markers.push({ lat, lng });
      this.render();
    }

    startDrag(e) {
      this.dragging = true;
      this.startX = e.clientX;
      this.startY = e.clientY;
    }

    drag(e) {
      if (!this.dragging) return;
      const dx = e.clientX - this.startX;
      const dy = e.clientY - this.startY;
      this.startX = e.clientX;
      this.startY = e.clientY;
      this.pan(dx, dy);
    }

    stopDrag() { this.dragging = false; }

    pan(dx, dy) {
      const scale = this.tileSize / Math.pow(2, this.zoom);
      this.center.lng -= dx * scale;
      this.center.lat += dy * scale;
      this.render();
    }

    zoomMap(e) {
      e.preventDefault();
      this.zoom += e.deltaY < 0 ? 1 : -1;
      if (this.zoom < 1) this.zoom = 1;
      if (this.zoom > 19) this.zoom = 19;
      this.render();
    }

    zoomIn() {
      this.zoom++;
      if (this.zoom > 19) this.zoom = 19;
      this.render();
    }

    touchStart(e) {
      if (e.touches.length === 1) {
        this.dragging = true;
        this.startX = e.touches[0].clientX;
        this.startY = e.touches[0].clientY;
      }
    }

    touchMove(e) {
      if (this.dragging && e.touches.length === 1) {
        const dx = e.touches[0].clientX - this.startX;
        const dy = e.touches[0].clientY - this.startY;
        this.startX = e.touches[0].clientX;
        this.startY = e.touches[0].clientY;
        this.pan(dx, dy);
      }
    }

    touchEnd() { this.dragging = false; }

    showAttribution() {
      const attr = document.createElement('div');
      attr.className = 'attribution';
      attr.innerHTML = 'Â© OpenStreetMap contributors | Atlas.js Lite v0.1';
      this.canvas.appendChild(attr);
    }
  }

  // Demo
  const map = new AtlasLite('map', {
    center: { lat: 31.63, lng: -8.00 }, // Marrakech ðŸ‡²ðŸ‡¦
    zoom: 6
  });
  map.addMarker(33.5731, -7.5898); // Casablanca
  map.addMarker(35.7595, -5.8340); // Tangier
  map.addMarker(31.63, -8.00);     // Marrakech
  </script>
</body>
</html>
